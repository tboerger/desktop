#!/usr/bin/env bash
set -eo pipefail

if [ -L $0 ]; then
    ROOT=$(cd $(dirname $(readlink -e $0))/..; pwd)
else
    ROOT=$(cd $(dirname $0)/..; pwd)
fi

if ! which ansible-playbook >/dev/null; then
    echo "Failed to detect playbook!"
    exit 1
fi

EXECUTE=$(basename $0)
STRIPPED=${EXECUTE%-playbook}
MACHINE=${MACHINE:-${STRIPPED}}

if [[ ! -d "${ROOT}/ansible/group_vars/${MACHINE}" ]]; then
    echo "Provided invalid machine!"
    exit 1
fi

if [[ -f "${ROOT}/.vaultpasswd" }}; then
    VAULT_PASSWORD_FILE="${ROOT}/.vaultpasswd"
else
    if [[ -z "${ANSIBLE_VAULT_PASSWORD}" ]]; then
        echo "Missing ANSIBLE_VAULT_PASSWORD!"
        exit 2
    fi

    VAULT_PASSWORD_FILE=$(mktemp)
    echo ${ANSIBLE_VAULT_PASSWORD} >| ${VAULT_PASSWORD_FILE}
fi

pushd "${ROOT}" >/dev/null
    exec ansible-playbook \
        --vault-password-file "${VAULT_PASSWORD_FILE}" \
        --inventory-file "ansible/inventory/${MACHINE}.yml" \
        ansible/playbook.yml \
        "$@"
popd >/dev/null
