#!/usr/bin/env bash
set -eo pipefail

MACHINE=${1:-unknown}
REPO=${REPO:-https://github.com/tboerger/desktop.git}
BASE=${BASE:-/home/thomas/.desktop}
USERNAME=${USERNAME:-thomas}

if ! hash git 2>/dev/null; then
    echo "--> install git"
    apt install --yes git curl
fi

if ! hash ansible 2>/dev/null; then
    echo "--> ansible gnupg"
    curl -S "https://keyserver.ubuntu.com/pks/lookup?op=get&search=0x6125E2A8C77F2818FB7BD15B93C4A3FD7BB9C367" | gpg --dearmor --output /usr/share/keyrings/ansible-archive-keyring.gpg

    echo "--> ansible repo"
    echo "deb [signed-by=/usr/share/keyrings/ansible-archive-keyring.gpg] https://ppa.launchpadcontent.net/ansible/ansible/ubuntu/ jammy main" >| /etc/apt/sources.list.d/ansible.list

    echo "--> install ansible"
    apt update && apt install --yes ansible
fi

if test -d "${BASE}"; then
    echo "--> updating itself"
    pushd "${BASE}" >/dev/null
        su -c "git pull --autostash --rebase" "${USERNAME}"
    popd >/dev/null
else
    echo "--> cloning itself"
    su -c "git clone ${REPO} ${BASE}" "${USERNAME}"
fi

for FILE in galaxy inventory later playbook vault update; do
    echo "--> linking ${FILE}"
    ln -sf "${BASE}/bin/${FILE}" "/usr/local/bin/${MACHINE}-${FILE}"
done

echo "--> finished bootstrap"
