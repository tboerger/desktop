#!/usr/bin/env bash
set -eo pipefail

MACHINE=${1:-unknown}
REPO=${REPO:-https://github.com/tboerger/desktop.git}
BASE=${BASE:-/home/thomas/.desktop}
USERNAME=${USERNAME:-thomas}

if ! hash ansible 2>/dev/null; then
    echo "--> install ansible"
    pip3 install ansible
fi

if test -d "${BASE}"; then
    echo "--> updating itself"
    pushd "${BASE}" >/dev/null
        su -c "git pull --autostash --rebase" "${USERNAME}"
    popd >/dev/null
else
    echo "--> cloning itself"
    su -c "git clone ${REPO} ${BASE}" "${USERNAME}"
fi

for FILE in galaxy inventory later playbook vault update; do
    echo "--> linking ${FILE}"
    ln -sf "${BASE}/bin/${FILE}" "/usr/local/bin/${MACHINE}-${FILE}"
done

echo "--> finished bootstrap"
